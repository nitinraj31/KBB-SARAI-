<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgriMarket | Agriculture Marketplace</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const LoginCard = ({ title, description, actionLabel, helperText, helperLink, role, onLogin, onRegister }) => {
      const [status, setStatus] = React.useState("");
      const [isLoading, setIsLoading] = React.useState(false);
      const [isRegister, setIsRegister] = React.useState(false);

      const handleSubmit = async (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const email = formData.get("email");
        const password = formData.get("password");

        setIsLoading(true);
        setStatus("");

        try {
          const endpoint = isRegister ? "/api/auth/register" : "/api/auth/login";
          const response = await fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password, role }),
          });

          const payload = await response.json();
          if (response.ok) {
            localStorage.setItem("token", payload.token);
            localStorage.setItem("user", JSON.stringify(payload.user));
            setStatus(isRegister ? "Account created successfully!" : "Signed in.");
            if (isRegister) {
              onRegister && onRegister(payload.user);
            } else {
              onLogin && onLogin(payload.user);
            }
          } else {
            setStatus(payload.message || "Error occurred.");
          }
        } catch (error) {
          setStatus("Unable to reach the server. Please try again.");
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className={`login-card ${role === "user" ? "alt" : ""}`}>
          <h2>{title}</h2>
          <p>{description}</p>
          <form onSubmit={handleSubmit}>
            <label>
              Email
              <input
                name="email"
                type="email"
                placeholder={role === "admin" ? "admin@agrimarket.com" : "you@email.com"}
                required
              />
            </label>
            <label>
              Password
              <input name="password" type="password" placeholder="Enter your password" required />
            </label>
            <button className="cta full" type="submit" disabled={isLoading}>
              {isLoading ? (isRegister ? "Creating account..." : "Signing in...") : (isRegister ? "Register" : actionLabel)}
            </button>
            <span className="helper">
              {helperText} <a href="#" onClick={() => setIsRegister(!isRegister)}>{isRegister ? "Already have an account? Login" : helperLink}</a>
            </span>
            {status && <span className="status">{status}</span>}
          </form>
        </div>
      );
    };

    const ProductCard = ({ product, onAddToCart }) => (
      <div className="product-card">
        <img src={product.image} alt={product.name} />
        <h4>{product.name}</h4>
        <div className="product-price">
          <span className="current-price">${product.price}</span>
          {product.original_price && <span className="original-price">${product.original_price}</span>}
          {product.discount && <span className="discount">{product.discount}% off</span>}
        </div>
        <div className="product-rating">
          <span>‚≠ê {product.rating}</span>
          <span>({product.reviews} reviews)</span>
        </div>
        <button className="add-to-cart" onClick={() => onAddToCart(product)}>Add to Cart</button>
      </div>
    );

    const CategoryCard = ({ category }) => (
      <div className="category-card">
        <img src={category.image} alt={category.name} />
        <h4>{category.name}</h4>
      </div>
    );

    const App = () => {
      const [categories, setCategories] = React.useState([]);
      const [products, setProducts] = React.useState([]);
      const [searchQuery, setSearchQuery] = React.useState("");
      const [user, setUser] = React.useState(null);
      const [cart, setCart] = React.useState([]);

      React.useEffect(() => {
        fetchCategories();
        fetchProducts();
        checkAuth();
      }, []);

      const fetchCategories = async () => {
        try {
          const response = await fetch('/api/categories');
          const data = await response.json();
          setCategories(data.categories || []);
        } catch (error) {
          console.error('Error fetching categories:', error);
        }
      };

      const fetchProducts = async (query = "") => {
        try {
          const url = query ? `/api/products?search=${encodeURIComponent(query)}` : '/api/products';
          const response = await fetch(url);
          const data = await response.json();
          setProducts(data.products || []);
        } catch (error) {
          console.error('Error fetching products:', error);
        }
      };

      const checkAuth = () => {
        const token = localStorage.getItem("token");
        const userData = localStorage.getItem("user");
        if (token && userData) {
          setUser(JSON.parse(userData));
        }
      };

      const handleSearch = (event) => {
        event.preventDefault();
        fetchProducts(searchQuery);
      };

      const handleLogin = (userData) => {
        setUser(userData);
      };

      const handleRegister = (userData) => {
        setUser(userData);
      };

      const addToCart = (product) => {
        setCart(prevCart => {
          const existing = prevCart.find(item => item.id === product.id);
          if (existing) {
            return prevCart.map(item =>
              item.id === product.id
                ? { ...item, quantity: item.quantity + 1 }
                : item
            );
          } else {
            return [...prevCart, { ...product, quantity: 1 }];
          }
        });
      };

      const featuredProducts = products.slice(0, 4);
      const deals = products.filter(p => p.discount > 0).slice(0, 4);

      return (
        <>
          <header className="site-header">
            <div className="brand">
              <span className="logo">üåæ</span>
              <div>
                <h1>AgriMarket</h1>
                <p>Grow your farm with quality products and supplies.</p>
              </div>
            </div>
            <nav>
              <form className="search-bar" onSubmit={handleSearch}>
                <input
                  type="text"
                  placeholder="Search for seeds, tools, machinery and more..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
                <button type="submit">Search</button>
              </form>
              <a href="#categories">Categories</a>
              <a href="#deals">Deals</a>
              <a href="#account">Account</a>
              <div className="cart-icon">
                <span>üõí</span>
                <span className="cart-count">{cart.reduce((sum, item) => sum + item.quantity, 0)}</span>
              </div>
              {user ? (
                <div className="user-menu">
                  <span>Welcome, {user.email}</span>
                  <button onClick={() => { localStorage.clear(); setUser(null); }}>Logout</button>
                </div>
              ) : (
                <button className="cta" onClick={() => window.location.hash = '#account'}>Login</button>
              )}
            </nav>
          </header>

          <nav className="categories-nav">
            <div className="categories-list">
              {categories.map((cat, index) => (
                <a key={index} href="#">{cat.name}</a>
              ))}
            </div>
          </nav>

          <main>
            <section className="hero-banner">
              <div className="banner-content">
                <h2>Harvest Season Sale!</h2>
                <p>Up to 50% off on tractors, seeds, fertilizers, and farming equipment.</p>
                <button className="cta">Shop Now</button>
              </div>
              <img src="https://via.placeholder.com/800x300?text=Harvest+Sale" alt="Harvest Sale Banner" />
            </section>

            <section id="categories" className="categories-section">
              <h2>Shop by Category</h2>
              <div className="categories-grid">
                {categories.map((cat, index) => (
                  <CategoryCard key={index} category={cat} />
                ))}
              </div>
            </section>

            <section className="featured-products">
              <h2>Featured Products</h2>
              <div className="products-grid">
                {featuredProducts.map(product => (
                  <ProductCard key={product.id} product={product} onAddToCart={addToCart} />
                ))}
              </div>
            </section>

            <section id="deals" className="deals-section">
              <h2>Today's Deals</h2>
              <div className="products-grid">
                {deals.map(product => (
                  <ProductCard key={product.id} product={product} onAddToCart={addToCart} />
                ))}
              </div>
            </section>

            <section id="account" className="account-section">
              <LoginCard
                title="Login / Signup"
                description="Get access to your orders, wishlist and recommendations."
                actionLabel="Login"
                helperText="New to AgriMarket?"
                helperLink="Create an account"
                role="user"
                onLogin={handleLogin}
                onRegister={handleRegister}
              />
            </section>
          </main>

          <footer>
            <div>
              <h3>AgriMarket</h3>
              <p>Empowering farmers worldwide with quality products and supplies.</p>
            </div>
            <div className="footer-links">
              <a href="#">About Us</a>
              <a href="#">Careers</a>
              <a href="#">Sell on AgriMarket</a>
              <a href="#">Help Center</a>
            </div>
          </footer>
        </>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
